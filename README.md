
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Решение 1
### Анализ задачи
Требования к API Gateway:
Маршрутизация запросов к сервисам на основе конфигурации.
Аутентификация — проверка токенов, ключей, заголовков.
HTTPS-терминация — приём TLS-трафика и проксирование внутрь в HTTP.
Терминация HTTPS (SSL/TLS termination) — это процесс, при котором API Gateway или балансировщик нагрузки принимает зашифрованный HTTPS-трафик от клиента, расшифровывает его (TLS handshake), а дальше внутри к сервисам пересылает уже обычный HTTP.

То есть:
Клиент (https://api.example.com) 
   -> [TLS handshake + дешифрация] API Gateway 
       -> (HTTP) -> внутренний сервис (http://service1:8080)
 Это даёт:
удобство: внутренние сервисы работают по простому HTTP (не нужно каждому настраивать сертификаты);
безопасность: наружу открыт только один endpoint (API Gateway) с сертификатом;
централизованное управление SSL-сертификатами (например, Let’s Encrypt, обновления, ротация ключей).

| Решение                  | Маршрутизация | Аутентификация (OAuth2/JWT/Key) | HTTPS-терминация | Доп. возможности | Стоимость внедрения |
|---------------------------|---------------|----------------------------------|------------------|------------------|---------------------|
| **NGINX (OSS/Plus)**     | Да (гибкая конфигурация `location/proxy_pass`) | Ограниченно (JWT/LDAP через модули; полноценный OIDC — в Plus) | Да, встроенный SSL/TLS | Высокая производительность, простая настройка | **Бесплатен (OSS)**, **NGINX Plus — коммерческая лицензия** |
| **Kong Gateway**         | Да (динамическая конфигурация, declarative config) | Да (JWT, OAuth2, Key-auth, OpenID, LDAP, плагины) | Да, встроено | Большая экосистема плагинов, UI (Konga/Enterprise), rate limiting | **Бесплатен (OSS)**, **Enterprise — платный** |
| **Traefik**              | Да (правила/лейблы, поддержка Kubernetes/Docker) | Да (JWT/OIDC через middleware, forwardAuth) | Да, авто-обновление Let’s Encrypt | Простая интеграция с Docker/K8s, auto-discovery сервисов | **Бесплатен (OSS)**, **Traefik Enterprise — платный** |
| **HAProxy**              | Да (ACL и маршрутизация) | Ограниченно (в основном через сторонние плагины или enterprise edition) | Да | Очень производительный, но слаб в API-менеджменте | **Полностью бесплатен (OSS)** |
| **AWS API Gateway**      | Да | Да (IAM, JWT, Cognito) | Да (через встроенные сертификаты) | Интеграция с AWS, serverless, rate limiting | **Платный (по запросам), дорого при больших нагрузках** |
| **Kubernetes Ingress**   | Да (через ingress rules) | Через sidecar/proxy (например, oauth2-proxy) | Да (TLS secrets + cert-manager) | Нативно для Kubernetes, гибкость, но требует интеграций | **Бесплатен (OSS)** |


### Оптимальный выбор — Kong Gateway.

Обоснование:
Поддерживает все необходимые требования «из коробки» (маршрутизация, HTTPS, аутентификация).
Огромное количество готовых плагинов (rate limiting, logging, monitoring, caching).
Хорошо подходит как для bare-metal/VM-развёртывания, так и для Kubernetes/Docker.
Есть как open-source, так и enterprise-версия (можно начать бесплатно, затем масштабироваться).

### Альтернатива — Traefik, если упор на лёгкость интеграции с Docker/Kubernetes и автоматическое управление сертификатами.

### Почему не Nginx 
NGINX OSS сам по себе — это скорее высокопроизводительный reverse proxy, а не API Gateway. Для аутентификации и полноценного API-менеджмента почти всегда нужен NGINX Plus (платный).
Traefik OSS же из коробки предоставляет:
автоматическое управление HTTPS (Let's Encrypt),
динамическое обнаружение сервисов (Docker/Kubernetes),
middleware для авторизации и JWT,
простое масштабирование.
Поэтому для бесплатного варианта альтернатива Kong — именно Traefik, а не NGINX.


## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.


## Решение 2

сравнительная таблица 

 | Решение              | Кластеризация / HA | Хранение сообщений на диске | Скорость работы | Поддержка форматов сообщений | Разделение прав доступа | Простота эксплуатации | Стоимость внедрения |
|-----------------------|--------------------|-----------------------------|-----------------|------------------------------|-------------------------|-----------------------|---------------------|
| **RabbitMQ**         | Да (кластер, quorum queues, mirrored queues) | Да (persistent storage, ACK) | Высокая, оптимален для transactional workloads | AMQP, MQTT, STOMP, HTTP API | Да (vhosts, users, ACL) | Средняя (нужна настройка кластеров, но удобный UI) | Бесплатен (OSS), есть коммерческая поддержка |
| **Apache Kafka**     | Да (Kafka Cluster + Zookeeper/KRaft) | Да (лог-сегменты на диске, ретенция) | Очень высокая (миллионы сообщений/сек) | JSON, Avro, Protobuf, любые бинарные форматы | Да (ACL на топики, интеграция с Kerberos) | Сложнее (нужна настройка ZooKeeper/KRaft, мониторинг) | Бесплатен (OSS), Confluent — платный |
| **ActiveMQ (Classic)** | Да (Master-Slave, Artemis — более современный) | Да | Средняя (уступает Kafka/RabbitMQ) | JMS, AMQP, MQTT, STOMP, OpenWire | Да | Средняя (Artemis проще, чем старый ActiveMQ) | Бесплатен (OSS) |
| **Redis (Streams)**  | Да (Redis Cluster, Sentinel) | Ограниченно (append-only log, snapshotting, не для долгого хранения) | Очень высокая (in-memory) | JSON, msgpack, произвольные бинарные данные | Да (ACL, RBAC с Redis 6+) | Простая (лёгкий деплой, но меньше возможностей как у MQ) | Бесплатен (OSS), Enterprise — платный |
| **NATS**             | Да (NATS JetStream cluster) | Да (JetStream persistence) | Очень высокая (низкая латентность) | JSON, Protobuf, любые бинарные | Да (accounts, permissions) | Простая (один бинарник, лёгкий запуск) | Бесплатен (OSS), Synadia SaaS — платный |


### Анализ под требования
Кластеризация / HA: поддерживают все (Kafka, RabbitMQ, Redis, NATS, ActiveMQ).
Хранение сообщений на диске: Kafka (сильная сторона), RabbitMQ (надёжный persist), NATS JetStream (добавлено), Redis — ограниченно.
Высокая скорость работы: лидеры Kafka, NATS, Redis; RabbitMQ — хорош для транзакционных сценариев.
Поддержка форматов сообщений: Kafka + NATS максимально универсальны, RabbitMQ — через стандартные протоколы.
Разделение прав доступа: RabbitMQ (vhosts, ACL) и Kafka (ACL на топики) очень сильны.
Простота эксплуатации: NATS и Redis — самые лёгкие; RabbitMQ — золотая середина; Kafka — требует опыта.

### Выбор
Оптимальный выбор — RabbitMQ:
Хорошо сбалансирован: простота эксплуатации, кластеризация, дисковая надёжность, гибкая аутентификация и ACL.
Подходит для большинства enterprise-сценариев.
Альтернатива — Apache Kafka, если акцент на:
очень высокую скорость (миллионы сообщений/сек),
большие объёмы данных и долгосрочное хранение логов,
обработку потоковых данных в реальном времени (stream processing).